#!/bin/bash

# Fail immediately on non-zero exit code.
set -e
# Fail immediately on non-zero exit code within a pipeline.
set -o pipefail
# Fail on undeclared variables.
set -u
# Debug, echo every command
#set -x

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BP_DIR=`cd $(dirname $0); cd ..; pwd`
KAFKACAT_BUILD_DIR=${BUILD_DIR}/.heroku

function topic() {
  echo "-----> $*"
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

#
# detect when building with inline buildpack
#
if [ ! -f $BP_DIR/kafkacat.c ] 
then
    BP_DIR=..
fi

eval "$BP_DIR/bin/make-kafkacat $@"

#cp $BP_DIR/kafkacat $KAFKACAT_BUILD_DIR/kafkacat

mkdir -p $BUILD_DIR/.profile.d
cp $BP_DIR/.profile.d/* $BUILD_DIR/.profile.d/

mkdir -p $BUILD_DIR/bin
cp $BP_DIR/bin/app/* $BUILD_DIR/bin/  


echo ""
topic "kafkacat built successfully!"
echo ""
